import{y as Ye,f as es,r as x,q as m,a$ as K,m as ss,s as c,Q as ts,aX as os,U as d,ap as de,a3 as Q,aI as U,H as ge}from"./index-0e396751.js";import{S as rs}from"./sortable.esm-be94e56d.js";import{b as is,g as ns,a6 as as,a7 as cs,aj as ls,ak as ps,al as _s,am as us,i as fs}from"./goods-4d7d064c.js";import{g as ds}from"./site-368fa7aa.js";import{j as gs}from"./poster-fe5eb9cd.js";import{r as hs}from"./range-91b90db8.js";function Ss(b={}){const he=Ye(),w=es(),D=x(!1),i=m({goods_id:"",goods_type:"real",goods_name:"",sub_title:"",goods_image:"",goods_category:"",brand_id:"",poster_id:"",label_ids:[],only_self:0,memory_ids:[],service_ids:[],supplier_id:"",status:"1",sort:"",is_proxy:1,addon_shop_supplier:[],spec_type:"single",price:"",market_price:"",cost_price:"",stock:"",sku_no:"",unit:"",virtual_sale_num:"",member_discount:"",attr_format:[],attr_id:"",goods_desc:"-"});Object.assign(i,b.formData),i.goods_id=x(he.query.goods_id);const me=b.appendFormData;Object.assign(i,me);const v=b.appendRefreshGoodsSkuData||{},X=b.appendSingleGoodsData,W=b.getFormRules,S=m({}),F=b.getFormRef,$=m([]),R=x(null);K(()=>{let e=F();for(let o in e)S[o]=e[o];b.getVerify&&$.splice(0,$.length,...b.getVerify())});const ye=b.editApi,ve=b.addApi,C=x("basic"),ke=(e,o)=>{},Y=m([]),be=e=>{w.push(e.path)};is().then(e=>{const o=e.data;if(o)for(const s in o)Y.push(o[s])});const j=m([]),we={multiple:!0},ee=e=>e.reduce((o,s)=>Array.isArray(s)?o.concat(ee(s)):o.concat(s),[]),se=e=>{if(!e||e.length===0){N.splice(0,N.length);return}const o=ee(e);if(o.length===0){N.splice(0,N.length);return}const s=o[o.length-1];s?ne(s):N.splice(0,N.length)},Ne=()=>{const e=w.resolve({path:"/phone_shop/goods/category"});window.open(e.href)},te=(e=!1)=>{ns().then(async o=>{const s=o.data;if(s){const t=[];s.forEach(a=>{const r=[];a.child_list&&a.child_list.forEach(p=>{r.push({value:p.category_id,label:p.category_name,memory_group:p.memory_group})}),t.push({value:a.category_id,label:a.category_name,memory_group:a.memory_group,children:r})}),j.splice(0,j.length,...t),e&&d({message:c("refreshSuccess"),type:"success"})}})};te();const L=m([]),Se=()=>{const e=w.resolve({path:"/phone_shop/goods/brand"});window.open(e.href)},oe=(e=!1)=>{as({}).then(o=>{const s=o.data;s&&(L.splice(0,L.length,...s),e&&d({message:c("refreshSuccess"),type:"success"}))})};oe(),(()=>{ds().then(e=>{R.value=e.data})})();const I=m([]),Ee=()=>{const e=w.resolve({path:"/poster/list"});window.open(e.href)},re=(e=!1)=>{gs({type:"shop_goods"}).then(o=>{const s=o.data;s&&(I.splice(0,I.length,...s),e&&d({message:c("refreshSuccess"),type:"success"}))})};re();const V=m([]),Te=()=>{const e=w.resolve({path:"/phone_shop/goods/label"});window.open(e.href)},ie=()=>{cs({}).then(e=>{const o=e.data;o&&V.splice(0,V.length,...o)})};ie();const N=m([]),xe=()=>{const e=w.resolve({path:"/phone_shop/goods/memory"});window.open(e.href)},ne=e=>{ls(e).then(o=>{const s=o.data;s&&N.splice(0,N.length,...s)})},q=m([]),Re=()=>{const e=w.resolve({path:"/phone_shop/goods/service"});window.open(e.href)},ae=()=>{ps({}).then(e=>{const o=e.data;o&&q.splice(0,q.length,...o)})};ae();const M=m([]),Oe=()=>{const e=w.resolve({path:"/shop_supplier/supplier"});window.open(e.href)},ce=()=>{_s({}).then(e=>{const o=e.data;o&&M.splice(0,M.length,...o)})},f=m([]),l=m({}),Z=m([]),le=x(0),E=()=>le.value>0,Pe=e=>{if(i.addon_shop_supplier=e.addon_shop_supplier,i.addon_shop_supplier&&i.addon_shop_supplier.status==1&&ce(),i.goods_id&&e.goods_info){if(le.value=e.goods_info.active_goods_count,i.goods_name=e.goods_info.goods_name,i.sub_title=e.goods_info.sub_title,i.goods_type=e.goods_info.goods_type,i.goods_image=e.goods_info.goods_image,i.goods_category=e.goods_info.goods_category,i.memory_ids=e.goods_info.memory_ids,i.brand_id=e.goods_info.brand_id,i.poster_id=e.goods_info.poster_id,i.label_ids=e.goods_info.label_ids,i.only_self=e.goods_info.only_self,i.service_ids=e.goods_info.service_ids,i.supplier_id=e.goods_info.supplier_id,i.status=e.goods_info.status,i.sort=e.goods_info.sort,i.is_proxy=e.goods_info.is_proxy,i.attr_format=e.goods_info.attr_format?JSON.parse(e.goods_info.attr_format):[],i.attr_id=e.goods_info.attr_id,z.value=!0,fe(i.attr_id||-1),i.spec_type=e.goods_info.spec_type,i.stock=e.goods_info.stock,i.spec_type=="single"){const o=e.goods_info.sku_list[0];i.price=o.price,i.market_price=o.market_price,i.cost_price=o.cost_price,i.sku_no=o.sku_no,X&&Object.assign(i,X(o))}else if(i.spec_type=="multi"){e.goods_info.spec_list.forEach(t=>{const a=[];t.spec_values=t.spec_values.split(","),t.spec_values.forEach(r=>{a.push({id:T(),spec_value_name:r})}),f.push({id:T(),spec_id:t.spec_id,goods_id:t.goods_id,spec_name:t.spec_name,values:a})}),O();const s=e.goods_info.sku_list;for(let t in l)for(let a=0;a<s.length;a++){let r=s[a];if(l[t].spec_name==r.sku_spec_format.replace(/,/g," ")){l[t].sku_id=r.sku_id,l[t].sku_image=r.sku_image,l[t].price=r.price,l[t].market_price=r.market_price,l[t].cost_price=r.cost_price;for(let p in v)l[t][p]=r[p];l[t].stock=r.stock,l[t].sku_id=r.sku_id,l[t].sku_no=r.sku_no,l[t].is_default=r.is_default;break}}K(()=>{P(),pe()})}i.member_discount=e.goods_info.member_discount,i.unit=e.goods_info.unit,i.virtual_sale_num=e.goods_info.virtual_sale_num,i.goods_desc=e.goods_info.goods_desc}},pe=()=>{if(!E()&&F().specValueRef)for(let e=0;e<F().specValueRef.length;e++){const o=F().specValueRef[e],s=rs.create(o,{group:"draggable-element-"+e,animation:200,onEnd:t=>{const a=f[e].values[t.oldIndex];f[e].values.splice(t.oldIndex,1),f[e].values.splice(t.newIndex,0,a),K(()=>{s.sort(hs(f[e].values.length).map(r=>r.toString())),O(),P()})}})}},T=(e=5)=>Number(Math.random().toString().substr(3,e)+Date.now()).toString(36),De=()=>{if(E()){d({type:"warning",message:`${c("participateInActiveDisableTips")}`});return}if(f.length>4){d({type:"warning",message:`${c("maxAddSpecTips")}`});return}f.push({id:T(),spec_name:"",values:[{id:T(),spec_value_name:""}]})},Fe=e=>{if(E()){d({type:"warning",message:`${c("participateInActiveDisableTips")}`});return}f.splice(e,1),O(),P(),B()},Ce=e=>{if(E()){d({type:"warning",message:`${c("participateInActiveDisableTips")}`});return}f[e].values.push({id:T(),spec_value_name:""}),pe()},Ae=de(e=>{O(),P()}),Ge=(e,o)=>{if(E()){d({type:"warning",message:`${c("participateInActiveDisableTips")}`});return}f[e].values.splice(o,1),O(),P(),B()},$e=(e,o)=>{for(const s in l)s==o?l[s].is_default=e:l[s].is_default=0},B=de(()=>{let e=0;for(const o in l)l[o].stock&&(e+=parseInt(l[o].stock));i.stock=e}),O=()=>{const e=f,o=Q(l);let s={},t=0;for(const r of e){let p={};if(Object.keys(s).length>0)for(const u in s)for(let _ of r.values){let h=Q(s[u].sku_spec);h.push(_),p["sku_"+t]={spec_name:`${s[u].spec_name} ${_.spec_value_name}`,sku_spec:h,sku_image:"",price:"",market_price:"",cost_price:"",stock:"",sku_no:"",is_default:0};for(let y in v)p["sku_"+t][y]=v[y].value;t++}else for(let u of r.values){let _=u.spec_value_name;p["sku_"+t]={spec_name:_,sku_spec:[u],sku_image:"",price:"",market_price:"",cost_price:"",stock:"",sku_no:"",is_default:0};for(let h in v)p["sku_"+t][h]=v[h].value;t++}s=Object.keys(p).length>0?p:s}for(const r in o)for(const p in s)if(je(o[r].sku_spec,s[p].sku_spec)===s[p].sku_spec.length){const _=s[p].spec_name,h=s[p].sku_spec;Object.assign(s[p],o[r]),s[p].spec_name=_,s[p].sku_spec=h;break}for(const r in l)delete l[r];let a="";for(const r in s)a==""?(a=r,s[r].is_default=1):s[r].is_default=0,l[r]=s[r]},je=(e,o)=>{let s=0;for(let t=0;t<e.length;t++)for(let a=0;a<o.length;a++)if(e[t].id===o[a].id){s++;break}return s},P=()=>{let e=0;for(let t=0;t<f.length;t++)f[t].spec_name!=""&&f[t].values.length>0&&e++;let o=1;const s=[];for(let t=e-1;t>=0;t--){for(let a=0;a<Object.keys(l).length;)if(f[t].values.length>0)for(let r of f[t].values)s.push({index:a,colSpan:t,rowSpan:o,spec_value_name:r.spec_value_name}),a=a+o;else a++;o=o*f[t].values.length}s.reverse(),Z.splice(0,Z.length,...s)},n=m({spec:"",price:"",market_price:"",cost_price:"",stock:"",sku_no:""});var _e={};for(let e in v)_e[e]=v[e].value;Object.assign(n,_e);const Le=()=>{if(n.price&&(isNaN(n.price)||!g.digit.test(n.price))){d({type:"warning",message:`${c("priceTips")}`});return}if(n.market_price&&(isNaN(n.market_price)||!g.digit.test(n.market_price))){d({type:"warning",message:`${c("marketPriceTips")}`});return}if(n.cost_price&&(isNaN(n.cost_price)||!g.digit.test(n.cost_price))){d({type:"warning",message:`${c("costPriceTips")}`});return}if(n.stock&&(isNaN(n.stock)||!g.number.test(n.stock))){d({type:"warning",message:`${c("stockTips")}`});return}for(let e in v){let o=g[v[e].regExp],s=v[e].message;if(n[e]&&(isNaN(n[e])||!o.test(n[e]))){d({type:"warning",message:s});return}}if(n.spec){n.price&&(l[n.spec].price=n.price),n.market_price&&(l[n.spec].market_price=n.market_price),n.cost_price&&(l[n.spec].cost_price=n.cost_price),n.stock&&(l[n.spec].stock=n.stock);for(let e in v)n[e]&&(l[n.spec][e]=n[e]);n.sku_no&&(l[n.spec].sku_no=n.sku_no)}else for(const e in l){n.price&&(l[e].price=n.price),n.market_price&&(l[e].market_price=n.market_price),n.cost_price&&(l[e].cost_price=n.cost_price),n.stock&&(l[e].stock=n.stock);for(let o in v)n[o]&&(l[e][o]=n[o]);n.sku_no&&(l[e].sku_no=n.sku_no)}n.price="",n.market_price="",n.cost_price="",n.stock="",n.sku_no="";for(let e in v)n[e]=""},g={required:/[\S]+/,number:/^\d{0,10}$/,digit:/^\d{0,10}(.?\d{0,2})$/,special:/^\d{0,10}(.?\d{0,3})$/},Ie=ss(()=>{let e={goods_name:[{required:!0,trigger:"blur",validator:(o,s,t)=>{s===""&&t(new Error(c("goodsNamePlaceholder"))),s.length>60?t(new Error(c("goodsNameMaxLengthTips"))):t()}}],sub_title:[{trigger:"blur",validator:(o,s,t)=>{s.length>80?t(new Error(c("subTitleMaxLengthTips"))):t()}}],goods_image:[{required:!0,message:c("goodsImagePlaceholder"),trigger:"blur"}],goods_category:[{required:!0,message:c("goodsCategoryPlaceholder"),trigger:"blur"}],sort:[{trigger:"blur",validator:(o,s,t)=>{isNaN(s)||!g.number.test(s)?t(new Error(c("sortTips"))):t()}}],price:[{trigger:"blur",validator:(o,s,t)=>{i.spec_type=="single"?s===""?t(new Error(c("pricePlaceholder"))):isNaN(s)||!g.digit.test(s)?t(new Error(c("priceTips"))):s<0?t(new Error(c("priceNotZeroTips"))):t():t()}}],market_price:[{trigger:"blur",validator:(o,s,t)=>{i.spec_type=="single"?isNaN(s)||!g.digit.test(s)?t(new Error(c("marketPriceTips"))):s<0?t(new Error(c("marketPriceNotZeroTips"))):t():t()}}],cost_price:[{trigger:"blur",validator:(o,s,t)=>{i.spec_type=="single"?isNaN(s)||!g.digit.test(s)?t(new Error(c("costPriceTips"))):s<0?t(new Error(c("costPriceNotZeroTips"))):t():t()}}],stock:[{trigger:"blur",validator:(o,s,t)=>{i.spec_type=="single"?s===""?t(new Error(c("stockPlaceholder"))):isNaN(s)||!g.number.test(s)?t(new Error(c("stockTips"))):s<0?t(new Error(c("stockNotZeroTips"))):t():t()}}],virtual_sale_num:[{trigger:"blur",validator:(o,s,t)=>{i.spec_type=="single"?isNaN(s)||!g.number.test(s)?t(new Error(c("virtualSaleNumTips"))):s<0?t(new Error(c("virtualSaleNumNotZeroTips"))):t():t()}}],spec_type:[{trigger:"blur",validator:(o,s,t)=>{i.spec_type=="multi"&&Object.keys(l).length==0&&t(new Error(c("pleaseEditSpecPlaceholder"))),t()}}],goods_desc:[{required:!0,trigger:["blur","change"],validator:(o,s,t)=>{if(s==="")t(new Error(c("goodsDescPlaceholder")));else{if(s.length<5||s.length>5e4)return t(new Error(c("goodsDescMaxTips"))),!1;t()}}}]};return W&&Object.assign(e,W(i,g)),e}),Ve=()=>[{trigger:"blur",validator:(e,o,s)=>{i.spec_type=="multi"?o.length==0?s(c("pricePlaceholder")):isNaN(o)||!g.digit.test(o)?s(c("priceTips")):o<0?s(c("priceNotZeroTips")):s():s()}}],qe=()=>[{trigger:"blur",validator:(e,o,s)=>{i.spec_type=="multi"?isNaN(o)||!g.digit.test(o)?s(c("marketPriceTips")):o<0?s(c("marketPriceNotZeroTips")):s():s()}}],Me=()=>[{trigger:"blur",validator:(e,o,s)=>{i.spec_type=="multi"?isNaN(o)||!g.digit.test(o)?s(c("costPriceTips")):o<0?s(c("costPriceNotZeroTips")):s():s()}}],Ze=()=>[{trigger:"blur",validator:(e,o,s)=>{i.spec_type=="multi"?o.length==0?s(c("stockPlaceholder")):isNaN(o)||!g.number.test(o)?s(c("stockTips")):o<0?s(c("stockNotZeroTips")):s():s()}}],Be=e=>{let o=[{key:"basic",verify:!1,ref:S.basicFormRef},{key:"price_stock",verify:!1,ref:S.priceStockFormRef},{key:"price_stock",verify:!1,ref:S.skuFormRef}];o=o.concat($);let s={key:"detail",verify:!1,ref:S.detailFormRef};if(o.push(s),o.forEach((t,a)=>{t.ref.validate(r=>{t.verify=r})}),i.spec_type=="multi"){let t=!0,a=[],r=[];for(let u=0;u<f.length;u++){const _=f[u];if(ge.require(_.spec_name)){t=!1,d({type:"warning",message:`${c("specNameRequire")}`});break}if(a.indexOf(_.spec_name)>-1){t=!1,d({type:"warning",message:`${c("specNameRepeat")}`});break}else a.push(_.spec_name);if(_.values.length)for(let h=0;h<_.values.length;h++){const y=_.values[h];if(ge.require(y.spec_value_name)){t=!1,d({type:"warning",message:`${c("specValueRequire")}`});break}if(r.indexOf(y.spec_value_name)>-1){t=!1,d({type:"warning",message:`${c("specValueNameRepeat")}`});break}else r.push(y.spec_value_name)}else t=!1,d({type:"warning",message:`${c("specValueRequire")}`});if(!t)break}if(!t){C.value="price_stock";return}let p=!1;for(const u in l)l[u].is_default&&(p=!0);if(!p){C.value="price_stock",d({type:"warning",message:`${c("lackDefaultSpec")}`});return}}setTimeout(()=>{let t=!0;for(let a=0;a<o.length;a++)if(o[a].verify==!1){C.value=o[a].key,t=!1;break}t&&e&&e()},10)},He=(e=null)=>{Be(()=>{if(D.value)return;D.value=!0;const o=i.goods_id?ye:ve,s=Q(i);if(s.spec_type=="multi"){s.stock=0;for(const r in l)l[r].stock&&(s.stock+=parseInt(l[r].stock))}const t=[];s.goods_category.forEach(r=>{typeof r=="object"?r.forEach(p=>{t.indexOf(p)==-1&&t.push(p)}):t.indexOf(r)==-1&&t.push(r)}),s.goods_category=t,s.goods_sku_data=l,s.goods_spec_format=f,s.attr_format=[],U(k).forEach((r,p)=>{if(r.attr_value_name&&r.select_child_val||r.attr_value_id>0){let u={};u.attr_value_id=r.attr_value_id,u.attr_value_name=r.attr_value_name,u.type=r.type,u.sort=r.sort,u.attr_child_value_id=r.select_child_name,u.attr_child_value_name=r.select_child_val,u.attr_child_value_color=r.select_child_color,s.attr_format.push(u)}}),s.attr_format.sort((r,p)=>p.sort-r.sort),s.attr_format=JSON.stringify(s.attr_format),e&&Object.assign(s,e(s)),o(s).then(r=>{D.value=!1,w.push("/phone_shop/goods/list")}).catch(()=>{D.value=!1})})},Je=()=>{w.push("/phone_shop/goods/list")},ze=e=>{e.target.value=e.target.value.replace(/[^\u4e00-\u9fa5a-zA-Z0-9\s]/g,""),e.target.value=e.target.value.replace(/[`~!@#$%^&*()_\-+=<>?:"{}|,.\/;'\\[\]·~！@#￥%……&*（）——\-+={}|《》？：“”【】、；‘’，。、]/g,"")},Ke=e=>{var o;(o=S.detailFormRef.value)==null||o.validateField("goods_desc")},H=m([]),ue=()=>{us({}).then(e=>{H.splice(0,H.length,...e.data)})};ue();let J=!1;const k=m([]),z=x(!1),fe=(e=0)=>{if(J||!e)return!1;J=!0;let o=e==-1?0:e;fs(o).then(s=>{let t=Object.keys(s.data).length&&s.data.attr_value_format?JSON.parse(s.data.attr_value_format):[],a=U(k);if(a=a.filter(r=>r.attr_value_id<=0),t.filter(r=>{r.select_child_name=r.type=="checkbox"?[]:"",r.select_child_val=r.type=="checkbox"?[]:""}),a=a.concat(t),k.splice(0,k.length,...a),J=!1,z.value){let r=i.attr_format.map(_=>_.attr_value_id),p=U(k);p=p.filter(_=>r.indexOf(_.attr_value_id)>-1),i.attr_format.forEach((_,h)=>{p.forEach((y,A,G)=>{y.attr_value_id==_.attr_value_id&&(G[A].select_child_name=_.attr_child_value_id,G[A].select_child_val=_.attr_child_value_name,G[A].sort=_.sort,G[A].select_child_color=_.color)})});let u=p.map(_=>_.attr_value_id);i.attr_format.forEach((_,h)=>{if(u.indexOf(_.attr_value_id)==-1&&_.type=="text"){let y={};y.attr_value_id=_.attr_value_id,y.attr_value_name=_.attr_value_name,y.sort=_.sort,y.type="text",y.select_child_name=_.attr_child_value_id,y.select_child_val=_.attr_child_value_name,p.push(y)}}),p.sort((_,h)=>h.sort-_.sort),console.log(p),k.splice(0,k.length,...p),z.value=!1}})},Qe=()=>{let e={attr_value_id:"",attr_value_name:"",child:{id:1,name:""},sort:"",type:"text",select_child_name:"",select_child_val:"",select_child_color:""};e.attr_value_id=-Math.floor(new Date().getSeconds()+Math.floor(new Date().getMilliseconds())),e.sort=k.length+1,k.push(e)},Ue=e=>{k.splice(e,1)},Xe=(e,o)=>{k.forEach((s,t,a)=>(s.type=="radio"&&s.child.forEach((r,p)=>{r.id==o&&(a[t].select_child_name=r.id,a[t].select_child_val=r.name,a[t].select_child_color=r.color)}),console.log(s),s))},We=(e,o)=>{k.forEach((s,t,a)=>{s.type=="checkbox"&&(a[t].select_child_val=[],s.child.forEach((r,p)=>{o.indexOf(r.id)>-1&&a[t].select_child_val.push({name:r.name,color:r.color||"#000"})}))})};return ts(()=>i.market_price,e=>{var r,p;if(!e||!R.value)return;const o=parseFloat(e);if(((r=R.value)==null?void 0:r.price_type)==1){const u=parseFloat((p=R.value)==null?void 0:p.member_markup);u?i.price=(o+u).toFixed(2):i.price=o.toFixed(2);return}const a=R.value.price_ranges.find(u=>{const _=parseFloat(u.min_price),h=parseFloat(u.max_price);return o>=_&&o<=h});if(a){const u=parseFloat(a.member_markup);i.price=(o+u).toFixed(2)}a||(i.price=o.toFixed(2))},{immediate:!0}),os(()=>{i.goods_category&&i.goods_category.length>0&&(console.log("商品分类发生变化:",i.goods_category),se(i.goods_category))}),{formData:i,activeName:C,tabHandleClick:ke,goodsType:Y,changeGoodsType:be,goodsCategoryOptions:j,goodsCategoryProps:we,categoryHandleChange:se,toGoodsCategoryEvent:Ne,refreshGoodsCategory:te,brandOptions:L,toGoodsBrandEvent:Se,refreshGoodsBrand:oe,posterOptions:I,toPosterEvent:Ee,refreshGoodsPoster:re,labelOptions:V,toGoodsLabelEvent:Te,refreshGoodsLabel:ie,memoryOptions:N,toGoodsMemoryEvent:xe,refreshGoodsMemory:ne,serviceOptions:q,toGoodsServiceEvent:Re,refreshGoodsService:ae,supplierOptions:M,toSupplierEvent:Oe,refreshSupplier:ce,goodsSpecFormat:f,goodsSkuData:l,specData:Z,generateRandom:T,isDisabledPrice:E,addSpec:De,deleteSpec:Fe,addSpecValue:Ce,specValueNameInputListener:Ae,deleteSpecValue:Ge,specValueIsDefaultChangeListener:$e,specStockSum:B,batchOperation:n,saveBatch:Le,regExp:g,formRules:Ie,skuPriceRules:Ve,skuMarketPriceRules:qe,skuCostPriceRules:Me,skuStockRules:Ze,handleGoodsInit:Pe,save:He,back:Je,filterSpecial:ze,handleBlur:Ke,attrOptions:H,attrChange:fe,getAttrListFn:ue,attrTableData:k,addAttr:Qe,delAttr:Ue,attrRadioChange:Xe,attrCheckboxChange:We}}export{Ss as u};
